/*
   pm.build.js ,version 1.2.1 ,updated on 2017-04-24
   module for Plugins Modules library.

   https://github.com/donghanji/pm
 */

!function(){if(void 0===module.declare)throw"There is no global module.declare method!";var a=module.globals("$");module.declare("pm.mobi",[a,"pm","pm.view","os"],function(b){function c(a){return a.replace(o.path,"/")}function d(a){return d.history?d.history:(this.baseURI=a.baseURI,this.timestamp=a.timestamp,d.routeView=a.routeView||!1,d.routeBaseURI=a.routeBaseURI||"",this.init(a.el,a.title,a.state),void(d.history=this))}function e(a){var b=g('[data-role="views"]');return b.length?(e.setOptions(a),e.$views=b,e.$gheader=g('[data-role="views"] > [data-role="global-header"]'),e.$gfooter=g('[data-role="views"] > [data-role="global-footer"]'),void e.init(b)):console.log('there is must be a views el,data-role="views" setting')}function f(a){return f.mobi?(e.setOptions(a),f.mobi):(new e(a),f.mobi=this,this)}var g=b(a),h=b("pm"),i=h.ns("view"),j=b("os"),k=window.location.pathname,l=window.document,m=l.documentElement,n={header:!0,footer:!0,loading:!0,destroy:!1,content:"",title:"",history:"",direction:"",data:""},o={html:/^<.+>$/,path:/(?:\/){2,}/g};return"pushState"in window.history||(window.history.pushState=function(){},window.history.replaceState=function(){}),d.prototype={init:function(a,b,c){history.state?this.pushState(a,b,c):this.replaceState(a,b,c)},handleState:function(a,b,e,f){var g=window.location.search;if(d.routeView){var h=a.replace("#",""),i=d.routeBaseURI||"/";h=d.routeView[h]||d.routeView[a],g=[i,h||a.replace("#view_item_","")].join("/")}if(this.timestamp){g=g||"";var j=new RegExp("(?:\\?|&)timestamp=\\d+");g=g.replace(j,""),g=g?[g,"&",this.timestamp,"=",(new Date).getTime()].join(""):["?",this.timestamp,"=",(new Date).getTime()].join("")}e&&(e=e.split(":"),f=e[0],e=e.length>1?e[1]:"",e&&!/^\//.test(e)&&(e="/"+e)),g=c(g);var k=d.routeView?"":a,l=c([e||this.baseURI,g,k].join("")),b=b||document.title,m={el:a,uri:l};f=f||"push",f+="State",window.history[f]&&window.history[f](m,b,l),document.title=b},replaceState:function(a,b,c){return this.handleState(a,b,c,"replace")},pushState:function(a,b,c){return this.handleState(a,b,c,"push")}},e.setOptions=function(a){a=a||{},a=g.extend(!0,a,e.options||{}),e.options=a,e.baseURI=k,e.zIndex=a.zIndex||100,e.normalWidth=a.normalWidth||640,e.normalMaxWidth=a.normalMaxWidth||768,e.normalMinWidth=a.normalMinWidth||320,e.basePX=a.normalPx||100,e.historyGoIndex=0,e.historyOptions={};var b=a.historyTimeStamp;b===!0&&(b="t"),e.historyTimeStamp=b?b:"",e.translateDuration=parseInt(a.duration||400),e.translateDirection=a.direction||"left",e.translateOffset=a.translateOffset||60,e.translateDelay=a.translateDelay||1,e.directions=a.directions||{left:"left",right:"right",up:"up",down:"down"},e.opposites=a.opposites||{left:"right",right:"left",up:"down",down:"up"},e.globalBeforeCallback=a.globalBeforeCallback,e.globalAfterCallback=a.globalAfterCallback,e.markup=a.markup||"div",d.routeView=d.routeView||a.routeView,d.routeBaseURI=d.routeBaseURI||a.routeBaseURI||""},e.init=function(){e.ViewCache={},e.viewWH(),e.initView(),e.setRem(),e.eventListener()},e.getDPR=function(){var a=window.devicePixelRatio;if(j.ios){if(a>=3)return 3;if(a>=2)return 2}return 1},e.setRem=function(){if(e.options.setRem){if("function"==typeof e.options.setRem)return e.options.setRem();var a=e.viewHeight,b=window.orientation;(90===b||-90===b||void 0===b)&&(a=e.viewWidth),a<e.normalMinWidth&&(a=e.normalMinWidth),a>e.normalMaxWidth&&(a=e.normalMaxWidth);var c=parseFloat(a*e.basePX/e.normalWidth).toFixed(2);m.style.fontSize=c+"px",e.REM=c}},e.initView=function(){var a=e.$views,b=a.find('[data-role="view"]'),c=a.find('[data-role="view"][data-actived]');c.removeAttr("data-actived"),c=c.length?c.eq(c.length-1):b.eq(b.length-1),c.attr("data-actived",!0);var f="#"+c.attr("id"),h=g(f).attr("data-history");b.each(function(){var a=g(this),b=a.attr("id");b="#"+b;var c=i.create({$view:a,el:b,mobis:{el:b}});e.getMobis(a,c.mobis),e.createMobiView(c)});var j=g('[data-mobi="container"]');j.length||(j=g('<div data-mobi="container"></div>').appendTo(g("body"))),j.attr("data-role","views"),e.$mobiView=j,e.activeView={el:f},e.history=new d({baseURI:e.baseURI,el:f,title:document.title,timestamp:e.historyTimeStamp,state:h}),e.loadToMobi(f),c.find('[data-role="loading"]').remove()},e.eventListener=function(){var a=e.$mobiView,b=a.tap?"tap":"click";a.on(b,e.checkAnchorClick),window.addEventListener("popstate",function(a){return a.state?e.goBack(a.state):void 0},!1),window.addEventListener("orientationchange",function(){e.setRem()})},e.loadToMobi=function(a){if(!a)return console.log("there is must be a view el");var b=e.getMobiView(a);if(!b.el)return console.log("there is no this view, can't to load it");e.headerAndFooter(b),e.loadingHandle(b);var c=e.$views.find(a);return e.$mobiView.append(c),b},e.viewWH=function(){var a=m.getBoundingClientRect(),b=a.width,c=a.height,d=window.orientation;return 90===d||-90===d||void 0===d?(e.viewWidth=b,e.viewHeight=c):(e.viewWidth=c,e.viewHeight=b),e.translateWidth=e.viewWidth+e.translateOffset,e.translateHeight=e.viewHeight+e.translateOffset,this},e.getMobis=function(a,b){for(var c in n){var d=a.attr("data-"+c);d="false"===d?!1:d||n[c],b[c]=d}return b},e.mobisViewOptions=function(a,b){b=b||{};for(var c in n){var d=n[c];d===b[c]&&delete b[c]}var e=g.extend({},a.mobis,b);return a.mobis=e,a},e.checkAnchorClick=function(a){var b=a.target;for(3===b.nodeType&&(b=b.parentNode);b!==this&&"A"!==b.tagName;)b=b&&b.parentNode?b.parentNode:this;var c=g(b),d=c.attr("data-ignore");if(!(""===d||d&&"false"!==d)){if(c.attr("data-to")){if(a.preventDefault(),e.translating)return console.log("translating");var f=c.attr("data-to");if(!f)return;var h=e.getMobis(c,{});return e.loadMobiView(f,h)}var i=c.attr("data-role");return"back"===i||"forward"===i?(a.preventDefault(),e.translating?console.log("translating"):window.history[i]&&window.history[i]()):void 0}},e.resize=function(){},e.created=function(a){if(!a)return!1;var b=e.ViewCache[a]||{};return b.mobis&&b.mobis.created?e.ViewCache[a]||!1:!1},e.isHtml=function(a){return o.html.test(a)},e.getEl=function(a){return"object"==typeof a&&(a=a.mobis.el),a},e.getMobiView=function(a){var a=e.getEl(a);return a?e.ViewCache[a]||{}:{}},e.createMobiView=function(a){var b=e.getEl(a);if(!b)return{};var c=e.created(b);return c?c:void(e.ViewCache[b]=a)},e.createdInDom=function(a){a=e.getEl(a);var b=g('[data-role="views"] > [data-role="view"]'+a);return b.length?b:!1},e.createDomView=function(a){a=a||{};var b=a.mobis||{},c=b.el;if(!c)return console.log("there is must be a view el");var d=e.createdInDom(c);if(d.length){var f=e.getMobiView(c);if(f.mobis.created)return f}var h=c.replace("#","");d=d.length?d:g("<"+e.markup+' data-role="view" id="'+h+'"/>');var f=i.create(a);f.$view=d,f.mobis=f.mobis||{},f.mobis.el=c,f.mobis.options=a,e.getMobis(d,f.mobis);var j=f.mobis.load;j&&j.call(f,f.mobis),e.$views.append(d),e.createMobiView(f),f.mobis.created=!0;var k=d.find('[data-role="content"]');k=k.length?k:e.isHtml(b.content)?g(b.content):"",k&&k.attr("data-role","content").appendTo(d);var l=b.loaded;return l&&l.call(f,f.mobis),f},e.getHTMLContent=function(a){return"function"==typeof a?a():a},e.setHF=function(a,b){b=b||"header";var c=a.$view,d=a.mobis,f=d[b]||"";if(f){var h=c.find('[data-role="'+b+'"]');if(f=e.getHTMLContent(f),e.isHtml(f)&&(h.remove(),h=g(f),h.attr("data-role",b)),h.length||(h="header"===b?e.$gheader.clone():e.$gfooter.clone()),h.show(),d.title){var i=h.find('[data-role="title"]');if(i.length){var j=d.title||i.text()||document.title||"";i.text(j)}}"header"===b?(c.find('[data-role="header"],[data-role="global-header"]').remove(),c.find('[data-role="content"]').before(h)):(c.find('[data-role="footer"],[data-role="global-footer"]').remove(),c.find('[data-role="content"]').after(h))}},e.headerAndFooter=function(a){var b=a.$view,c=b.find('[data-role="content"]');if(c.length){var d=b.find('[data-role="header"]'),f=b.find('[data-role="footer"]'),g=a.mobis;return g.header?e.setHF(a,"header"):d.hide(),g.footer?e.setHF(a,"footer"):f.hide(),this}},e.loadingHandle=function(a){var b=a.mobis,c=a.$view,d=c.find('[data-role="content"]');if(b.loading||b.content&&!e.isHtml(b.content)){if("background"===b.loading||b.content&&!e.isHtml(b.content))return d.addClass("content-loading"),this;var f=b.loading===!0?e.options.loading:b.loading;f=e.getHTMLContent(f);var h=g(f);h.attr("data-role","loading"),c.find('[data-role="content"]').append(h)}return this},e.appendContent=function(a,b,c){var d=a.$view,e=d.find('[data-role="content"]');b&&(e.length?e.html(b):d.html(b)),e.removeClass("content-loading"),c&&c()},e.contentHandle=function(a,b){var c=a.mobis,d=a.$view,f=d.find('[data-role="content"]');if(c.content){var h=e.getHTMLContent(c.content);if(e.isHtml(h))return e.appendContent(a,h,b);if(h)return g("<div/>").load(c.content,function(c){return e.appendContent(a,c,b)})}f.removeClass("content-loading"),d.find('[data-role="loading"]').remove(),b&&b()},e.doAnimation=function(a,b,c){var d=c.direction||"left",f=c.mobis||{};e.$mobiView.prepend(b),b.addClass("mobi-to-view").addClass(d).addClass("initial"),e.$mobiView.addClass("animate").addClass(d);var g=function(){return c.before&&c.before(),b.removeClass("initial")};setTimeout(g,1);var h=function(){return"no"!==f.destroy?a.appendTo(e.$views):a.removeAttr("data-actived"),b.removeClass("mobi-to-view").removeClass(d),e.$mobiView.removeClass("animate").removeClass(d),c.after&&c.after()};return setTimeout(h,e.translateDuration)},e.loadContent=function(a,b){if(e.translating)return console.log("translating");b=b||{},a=e.getEl(a);var c=e.getMobiView(a);if(!c)return console.log("there is no this view, can't to load it");if(!a||a!==e.activeView.el){var d=e.createDomView(c),f=e.getMobiView(e.activeView.el),g=e.mobisViewOptions(d,b),h=g.mobis,i=(e.$views,e.$mobiView.find(e.activeView.el)),j=g.$view,k=h.perload;k&&k.call(g,g.mobis,f);var l=h.direction||e.translateDirection;return d.mobis.direction=l,1===d.mobis.directionTag?(l=f.mobis.direction,l=e.opposites[l]):l=e.directions[l],1===d.mobis.directionTag&&0===f.mobis.directionTag?(f.mobis.directionTag=-1,d.mobis.directionTag=0):(d.mobis.directionTag=0,f.mobis.directionTag=1),e.translating=!0,e.activeView.el=h.el,e.activeView.history=h.history,e.doAnimation(i,j,{direction:l,mobis:g.mobis,before:function(){e.globalBeforeCallback&&e.globalBeforeCallback(g,g.mobis,f),e.$mobiView.css({overflow:"visible"}),e.loadToMobi(a)},after:function(){e.contentHandle(g,function(){var a=h.perloaded;a&&a.call(g,g.mobis,f),e.globalAfterCallback&&e.globalAfterCallback.call(g,g.mobis,f),j.attr("data-actived",!0),e.translating=!1,e.$mobiView.css({overflow:"hidden"}),e.historyOptions={};var b=f.mobis.destroy,c=f.$view;if("view"===b)return c.empty();var d=c.find('[data-role="content"]');return"content"===b||b===!0?d.empty():"remove"===b?d.remove():void 0})}})}},e.loadMobiView=function(a,b){var c=e.getMobiView(a);if(!c.el)return console.log("load a view ,must be an el setting");c.mobis.directionTag=0,e.loadContent(a,b);var d=c.mobis,f=d.history||"push";"nochange"!==f&&e.history.handleState(a,d.title,f)},e.loadMobiBackView=function(a){a=a||{};var b=a.el,c=e.getMobiView(b),d=e.getMobiView(e.activeView.el),f=d.mobis||{},h=f.goback,i=f.reload,j=f.goforward,k=e.historyGoIndex;if("disabled"===h&&1===c.mobis.directionTag)return k=k?-k:1,history.go(k),e.historyGoIndex=0;if("disabled"===j&&-1===c.mobis.directionTag)return k=k?-k:-1,history.go(k),e.historyGoIndex=0;var l={};if(h&&"function"==typeof h&&1===c.mobis.directionTag&&(l=h.call(d,a,f)),j&&"function"==typeof j&&-1===c.mobis.directionTag&&(l=j.call(d,a,f)),i&&!c.mobis.directionTag&&a.el===f.el){if("function"==typeof i)return i.call(d,a,f);if(a.uri)return location.reload()}a=g.extend(a,e.historyOptions,l),e.loadContent(b,a)},e.goBack=function(a){return a=a||{},e.translating?console.log("translating"):e.loadMobiBackView(a)},f.prototype={view:function(a){if(a=a||{},a&&"string"==typeof a)return e.getMobiView(a);var b=a.el;if(!b)return console.log("there is must be a view el");var b=a.el;if(!b)return console.log("there is must be a view el");var c=e.created(b);if(c)return c;var d=e.createdInDom(b);return c=e.getMobiView(b),c.mobis=g.extend({el:b,created:!1},c.mobis||{},a.mobis),delete a.mobis,c=g.extend(c,a),d&&d.length?(a.mobis=c.mobis,c=i.create(a),c.$view=d,c.mobis=c.mobis||{},c.mobis.el=b,c.mobis.options=a,e.createMobiView(c),c.mobis.created=!0,this):(e.createMobiView(c),this)},load:function(a,b){return a=e.getEl(a),a?e.loadMobiView(a,b):console.log("load a view ,must be an el setting")},go:function(a,b){return a=parseInt(a),a&&(e.historyOptions=b||{},e.historyGoIndex=a,window.history.go(a)),this},goback:function(a){return e.historyOptions=a||{},window.history.back(),this},goforward:function(a){return e.historyOptions=a||{},window.history.forward(),this}},f})}();