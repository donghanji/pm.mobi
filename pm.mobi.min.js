/*
   pm.build.js ,version 1.2.1 ,updated on 2016-03-07
   module for Plugins Modules library.

   https://github.com/donghanji/pm
 */

!function(){if(void 0===module.declare)throw"There is no global module.declare method!";var a=module.globals("$");module.declare("pm.mobi",[a,"pm","pm.view","os"],function(b){function c(a){return c.history?c.history:(this.baseURI=a.baseURI,this.timestamp=a.timestamp,this.init(a.el,a.title,a.state),void(c.history=this))}function d(a){a=a||{};var b=f('[data-role="views"]');if(!b.length)return console.log('there is must be a views el,data-role="views" setting');d.options=a,d.baseURI=j,d.zIndex=a.zIndex||100,d.normalWidth=a.normalWidth||640,d.normalMaxWidth=a.normalMaxWidth||768,d.normalMinWidth=a.normalMinWidth||320,d.basePX=a.normalPx||100,d.historyGoIndex=0,d.historyOptions={};var c=a.historyTimeStamp;c===!0&&(c="t"),d.historyTimeStamp=c?c:"",d.translateDuration=parseInt(a.duration||400),d.translateDirection=a.direction||"left",d.translateOffset=a.translateOffset||60,d.translateDelay=a.translateDelay||1,d.directions=a.directions||{left:"left",right:"right",up:"up",down:"down"},d.opposites=a.opposites||{left:"right",right:"left",up:"down",down:"up"},d.$views=b,d.$gheader=f('[data-role="views"] > [data-role="global-header"]'),d.$gfooter=f('[data-role="views"] > [data-role="global-footer"]'),d.markup=a.markup||"div",d.init(b)}function e(a){return e.mobi?e.mobi:(new d(a),e.mobi=this,this)}var f=b(a),g=b("pm"),h=g.ns("view"),i=b("os"),j=window.location.pathname,k=window.document,l=k.documentElement,m={header:!0,footer:!0,loading:!0,destroy:!1,content:"",title:"",history:"",direction:"",data:""},n={html:/^<.+>$/};return"pushState"in window.history||(window.history.pushState=function(){},window.history.replaceState=function(){}),c.prototype={init:function(a,b,c){history.state?this.pushState(a,b,c):this.replaceState(a,b,c)},handleState:function(a,b,c,d){var e=window.location.search;if(this.timestamp){searc=e||"";var f=new RegExp("(?:\\?|&)timestamp=\\d+");e=e.replace(f,""),e=e?[e,"&",this.timestamp,"=",(new Date).getTime()].join(""):["?",this.timestamp,"=",(new Date).getTime()].join("")}c&&(c=c.split(":"),d=c[0],c=c.length>1?c[1]:"",/^\//.test(c)||(c="/"+c));var g=[c||this.baseURI,e,a].join(""),b=b||document.title,h={el:a,uri:g};d=d||"push",d+="State",window.history[d]&&window.history[d](h,b,g),document.title=b},replaceState:function(a,b,c){return this.handleState(a,b,c,"replace")},pushState:function(a,b,c){return this.handleState(a,b,c,"push")}},d.init=function(){d.ViewCache={},d.viewWH(),d.initView(),d.setRem(),d.eventListener()},d.getDPR=function(){var a=window.devicePixelRatio;if(i.ios){if(a>=3)return 3;if(a>=2)return 2}return 1},d.setRem=function(){if(d.options.setRem){if("function"==typeof d.options.setRem)return d.options.setRem();var a=d.viewHeight,b=window.orientation;(90===b||-90===b||void 0===b)&&(a=d.viewWidth),a<d.normalMinWidth&&(a=d.normalMinWidth),a>d.normalMaxWidth&&(a=d.normalMaxWidth),rem=parseFloat(a*d.basePX/d.normalWidth).toFixed(2),l.style.fontSize=rem+"px",d.REM=rem}},d.initView=function(){var a=d.$views,b=a.find('[data-role="view"]'),e=a.find('[data-role="view"][data-actived]');e.removeAttr("data-actived"),e=e.length?e.eq(e.length-1):b.eq(b.length-1),e.attr("data-actived",!0);var g="#"+e.attr("id"),i=f(g).attr("data-history");b.each(function(){var a=f(this),b=a.attr("id");b="#"+b;var c=h.create({$view:a,el:b,mobis:{el:b}});d.getMobis(a,c.mobis),d.createMobiView(c)});var j=f('[data-mobi="container"]');j.length||(j=f('<div data-mobi="container"></div>').appendTo(f("body"))),j.attr("data-role","views"),d.$mobiView=j,d.activeView={el:g},d.history=new c({baseURI:d.baseURI,el:g,title:document.title,timestamp:d.historyTimeStamp,state:i}),d.loadToMobi(g),e.find('[data-role="loading"]').remove()},d.eventListener=function(){var a=d.$mobiView,b=a.tap?"tap":"click";a.on(b,d.checkAnchorClick),window.addEventListener("popstate",function(a){return a.state?d.goBack(a.state):void 0},!1),window.addEventListener("orientationchange",function(){d.setRem()})},d.loadToMobi=function(a){if(!a)return console.log("there is must be a view el");var b=d.getMobiView(a);if(!b.el)return console.log("there is no this view, can't to load it");d.headerAndFooter(b),d.loadingHandle(b);var c=d.$views.find(a);return d.$mobiView.append(c),b},d.viewWH=function(){var a=l.getBoundingClientRect(),b=a.width,c=a.height,e=window.orientation;return 90===e||-90===e||void 0===e?(d.viewWidth=b,d.viewHeight=c):(d.viewWidth=c,d.viewHeight=b),d.translateWidth=d.viewWidth+d.translateOffset,d.translateHeight=d.viewHeight+d.translateOffset,this},d.getMobis=function(a,b){for(var c in m){var d=a.attr("data-"+c);d="false"===d?!1:d||m[c],b[c]=d}return b},d.mobisViewOptions=function(a,b){b=b||{};for(var c in m){var d=m[c];d===b[c]&&delete b[c]}var e=f.extend({},a.mobis,b);return a.mobis=e,a},d.checkAnchorClick=function(a){var b=a.target;for(3===b.nodeType&&(b=b.parentNode);b!==this&&"A"!==b.tagName;)b=b&&b.parentNode?b.parentNode:this;var c=f(b),e=c.attr("data-ignore");if(!(""===e||e&&"false"!==e)){if(c.attr("data-to")){if(a.preventDefault(),d.translating)return console.log("translating");var g=c.attr("data-to");if(!g)return;var h=d.getMobis(c,{});return d.loadMobiView(g,h)}var i=c.attr("data-role");return"back"===i||"forward"===i?(a.preventDefault(),d.translating?console.log("translating"):window.history[i]&&window.history[i]()):void 0}},d.resize=function(){},d.created=function(a){if(!a)return!1;var b=d.ViewCache[a]||{};return b.mobis&&b.mobis.created?d.ViewCache[a]||!1:!1},d.isHtml=function(a){return n.html.test(a)},d.getEl=function(a){return"object"==typeof a&&(a=a.mobis.el),a},d.getMobiView=function(a){var a=d.getEl(a);return a?d.ViewCache[a]||{}:{}},d.createMobiView=function(a){var b=d.getEl(a);if(!b)return{};var c=d.created(b);return c?c:void(d.ViewCache[b]=a)},d.createdInDom=function(a){a=d.getEl(a);var b=f('[data-role="views"] > [data-role="view"]'+a);return b.length?b:!1},d.createDomView=function(a){a=a||{};var b=a.mobis||{},c=b.el;if(!c)return console.log("there is must be a view el");var e=d.createdInDom(c);if(e.length){var g=d.getMobiView(c);if(g.mobis.created)return g}var i=c.replace("#","");e=e.length?e:f("<"+d.markup+' data-role="view" id="'+i+'"/>');var g=h.create(a);g.$view=e,g.mobis=g.mobis||{},g.mobis.el=c,g.mobis.options=a,d.getMobis(e,g.mobis);var j=g.mobis.load;j&&j.call(g),d.$views.append(e),d.createMobiView(g),g.mobis.created=!0;var k=e.find('[data-role="content"]');k=k.length?k:d.isHtml(b.content)?f(b.content):"",k&&k.attr("data-role","content").appendTo(e);var l=b.loaded;return l&&l.call(g),g},d.getHTMLContent=function(a){return"function"==typeof a?a():a},d.setHF=function(a,b){b=b||"header";var c=a.$view,e=a.mobis,g=e[b]||"";if(g){var h=c.find('[data-role="'+b+'"]');if(g=d.getHTMLContent(g),d.isHtml(g)&&(h.remove(),h=f(g),h.attr("data-role",b)),h.length||(h="header"===b?d.$gheader.clone():d.$gfooter.clone()),h.show(),e.title){var i=h.find('[data-role="title"]');if(i.length){var j=e.title||i.text()||document.title||"";i.text(j)}}"header"===b?(c.find('[data-role="header"],[data-role="global-header"]').remove(),c.find('[data-role="content"]').before(h)):(c.find('[data-role="footer"],[data-role="global-footer"]').remove(),c.find('[data-role="content"]').after(h))}},d.headerAndFooter=function(a){var b=a.$view,c=b.find('[data-role="content"]');if(c.length){var e=b.find('[data-role="header"]'),f=b.find('[data-role="footer"]'),g=a.mobis;return g.header?d.setHF(a,"header"):e.hide(),g.footer?d.setHF(a,"footer"):f.hide(),this}},d.loadingHandle=function(a){var b=a.mobis,c=a.$view,e=c.find('[data-role="content"]');if(b.loading||b.content&&!d.isHtml(b.content)){if("background"===b.loading||b.content&&!d.isHtml(b.content))return e.addClass("content-loading"),this;var g=b.loading===!0?d.options.loading:b.loading;g=d.getHTMLContent(g);var h=f(g);h.attr("data-role","loading"),c.find('[data-role="content"]').append(h)}return this},d.appendContent=function(a,b,c){var d=a.$view,e=d.find('[data-role="content"]');b&&(e.length?e.html(b):d.html(b)),e.removeClass("content-loading"),c&&c()},d.contentHandle=function(a,b){var c=a.mobis,e=a.$view,g=e.find('[data-role="content"]');if(c.content){var h=d.getHTMLContent(c.content);if(d.isHtml(h))return d.appendContent(a,h,b);if(h)return f("<div/>").load(c.content,function(c){return d.appendContent(a,c,b)})}g.removeClass("content-loading"),e.find('[data-role="loading"]').remove(),b&&b()},d.doAnimation=function(a,b,c){var e=c.direction||"left";d.$mobiView.prepend(b),b.addClass("mobi-to-view").addClass(e).addClass("initial"),d.$mobiView.addClass("animate").addClass(e);var f=function(){return c.before&&c.before(),b.removeClass("initial")};setTimeout(f,1);var g=function(){return a.appendTo(d.$views),b.removeClass("mobi-to-view").removeClass(e),d.$mobiView.removeClass("animate").removeClass(e),c.after&&c.after()};return setTimeout(g,d.translateDuration)},d.loadContent=function(a,b){if(d.translating)return console.log("translating");b=b||{},a=d.getEl(a);var c=d.getMobiView(a);if(!c)return console.log("there is no this view, can't to load it");if(!a||a!==d.activeView.el){var e=d.createDomView(c),f=d.getMobiView(d.activeView.el),g=d.mobisViewOptions(e,b),h=g.mobis,i=(d.$views,d.$mobiView.find(d.activeView.el)),j=g.$view,k=h.perload;k&&k.call(g);var l=h.direction||"left";return e.mobis.direction=h.direction||d.translateDirection,1===e.mobis.directionTag?(l=f.mobis.direction,l=d.opposites[l]):l=d.directions[l],1===e.mobis.directionTag&&0===f.mobis.directionTag?(f.mobis.directionTag=-1,e.mobis.directionTag=0):(e.mobis.directionTag=0,f.mobis.directionTag=1),d.translating=!0,d.activeView.el=h.el,d.activeView.history=h.history,d.doAnimation(i,j,{direction:l,before:function(){d.$mobiView.css({overflow:"visible"}),d.loadToMobi(a)},after:function(){d.contentHandle(g,function(){var a=h.perloaded;a&&a.call(g),j.attr("data-actived",!0),d.translating=!1,d.$mobiView.css({overflow:"hidden"}),d.historyOptions={};var b=f.mobis.destroy,c=f.$view;if("view"===b)return c.empty();var e=c.find('[data-role="content"]');return"content"===b||b===!0?e.empty():"remove"===b?e.remove():void 0})}})}},d.loadMobiView=function(a,b){var c=d.getMobiView(a);if(!c.el)return console.log("load a view ,must be an el setting");c.mobis.directionTag=0,d.loadContent(a,b);var e=c.mobis,f=e.history||"push";"nochange"!==f&&d.history.handleState(a,e.title,f)},d.loadMobiBackView=function(a){a=a||{};var b=a.el,c=d.getMobiView(b),e=d.getMobiView(d.activeView.el),g=e.mobis||{},h=g.goback,i=g.reload,j=g.goforward,k=d.historyGoIndex;if("disabled"===h&&1===c.mobis.directionTag)return k=k?-k:1,history.go(k),d.historyGoIndex=0;if("disabled"===j&&-1===c.mobis.directionTag)return k=k?-k:-1,history.go(k),d.historyGoIndex=0;var l={};if(h&&"function"==typeof h&&1===c.mobis.directionTag&&(l=h.call(e,a,g)),j&&"function"==typeof j&&-1===c.mobis.directionTag&&(l=j.call(e,a,g)),i&&!c.mobis.directionTag&&a.el===g.el){if("function"==typeof i)return i.call(e,a,g);if(a.uri)return location.reload()}a=f.extend(a,d.historyOptions,l),d.loadContent(b,a)},d.goBack=function(a){return a=a||{},d.translating?console.log("translating"):d.loadMobiBackView(a)},e.prototype={view:function(a){if(a=a||{},a&&"string"==typeof a)return d.getMobiView(a);var b=a.el;if(!b)return console.log("there is must be a view el");var b=a.el;if(!b)return console.log("there is must be a view el");var c=d.created(b);if(c)return c;var e=d.createdInDom(b);return c=d.getMobiView(b),c.mobis=f.extend({el:b,created:!1},c.mobis||{},a.mobis),delete a.mobis,c=f.extend(c,a),e&&e.length?(a.mobis=c.mobis,c=h.create(a),c.$view=e,c.mobis=c.mobis||{},c.mobis.el=b,c.mobis.options=a,d.createMobiView(c),c.mobis.created=!0,this):(d.createMobiView(c),this)},load:function(a,b){return a=d.getEl(a),a?d.loadMobiView(a,b):console.log("load a view ,must be an el setting")},go:function(a,b){return a=parseInt(a),a&&(d.historyOptions=b||{},d.historyGoIndex=a,window.history.go(a)),this},goback:function(a){return d.historyOptions=a||{},window.history.back(),this},goforward:function(a){return d.historyOptions=a||{},window.history.forward(),this}},e})}();